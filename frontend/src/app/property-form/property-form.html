<app-header [showCreateProperty]="false"></app-header>

<div class="container">
  <h2>{{ editMode ? 'Editar Im√≥vel' : 'Cadastrar Im√≥vel' }}</h2>

  <form (ngSubmit)="onSubmit()" [formGroup]="propertyForm">

    <div class="form-group">
      <label for="title">T√≠tulo do An√∫ncio</label>
      <input class="form-control" formControlName="title" id="title" placeholder="Ex: Quarto individual perto da UFAPE"
             type="text">
      <div *ngIf="propertyForm.get('title')?.invalid && propertyForm.get('title')?.touched" class="error">
        O t√≠tulo √© obrigat√≥rio e deve ter entre 5 e 100 caracteres.
      </div>
    </div>

    <div class="form-group">
      <label for="type">Tipo de Im√≥vel</label>
      <select class="form-control" formControlName="type" id="type">
        <option [ngValue]="null" disabled>Selecione...</option>
        <option *ngFor="let type of propertyTypes" [value]="type">
          {{ getLabelForType(type) }}
        </option>
      </select>
      <div *ngIf="propertyForm.get('type')?.invalid && propertyForm.get('type')?.touched" class="error">
        Selecione um tipo.
      </div>
    </div>

    <div class="form-group">
      <label for="price">Pre√ßo (R$)</label>
      <input class="form-control" formControlName="price" id="price" placeholder="0.00" type="number">
      <div *ngIf="propertyForm.get('price')?.invalid && propertyForm.get('price')?.touched" class="error">
        O pre√ßo √© obrigat√≥rio e deve ser positivo.
      </div>
    </div>

    <div class="form-group">
      <label for="vacancies">N¬∫ de Quartos / Vagas</label>
      <input class="form-control" formControlName="availableVacancies" id="vacancies" type="number">
      <div *ngIf="propertyForm.get('availableVacancies')?.invalid && propertyForm.get('availableVacancies')?.touched"
           class="error">
        Informe pelo menos 1 vaga.
      </div>
    </div>

    <div class="form-group">
      <label for="description">Descri√ß√£o</label>
      <textarea class="form-control" formControlName="description" id="description" rows="3"></textarea>
    </div>

    <hr>
    <h3>Endere√ßo</h3>

    <div class="address-group" formGroupName="address">

      <div class="form-group">
        <label for="street">Rua</label>
        <input class="form-control" formControlName="street" id="street" type="text">
        <div *ngIf="propertyForm.get('address.street')?.invalid && propertyForm.get('address.street')?.touched"
             class="error">
          A rua √© obrigat√≥ria.
        </div>
      </div>

      <div class="form-group">
        <label for="number">N√∫mero</label>
        <input class="form-control" formControlName="number" id="number" type="text">
        <div *ngIf="propertyForm.get('address.number')?.invalid && propertyForm.get('address.number')?.touched"
             class="error">
          O n√∫mero √© obrigat√≥rio.
        </div>
      </div>

      <div class="form-group">
        <label for="district">Bairro</label>
        <input class="form-control" formControlName="district" id="district" type="text">
        <div *ngIf="propertyForm.get('address.district')?.invalid && propertyForm.get('address.district')?.touched"
             class="error">
          O bairro √© obrigat√≥rio.
        </div>
      </div>

      <div class="form-group">
        <label for="city">Cidade</label>
        <input class="form-control" formControlName="city" id="city" type="text">
        <div *ngIf="propertyForm.get('address.city')?.invalid && propertyForm.get('address.city')?.touched"
             class="error">
          A cidade √© obrigat√≥ria.
        </div>
      </div>

      <div class="form-group">
        <label for="state">Estado</label>
        <input class="form-control" formControlName="state" id="state" placeholder="Ex: PE" type="text">
        <div *ngIf="propertyForm.get('address.state')?.invalid && propertyForm.get('address.state')?.touched"
             class="error">
          O estado √© obrigat√≥rio.
        </div>
      </div>

      <div class="form-group">
        <label for="cep">CEP</label>
        <input class="form-control" formControlName="cep" id="cep" placeholder="00000-000" type="text">
        <div *ngIf="propertyForm.get('address.cep')?.invalid && propertyForm.get('address.cep')?.touched" class="error">
          O CEP √© inv√°lido.
        </div>
      </div>
    </div>

    <hr>
    <h3>Caracter√≠sticas</h3>

    <div class="toggle-group">

      <div class="toggle-item">
        <span class="toggle-label">Aceita animais?</span>
        <div class="toggle-buttons">
          <button (click)="propertyForm.get('acceptAnimals')?.setValue(true)"
                  [class.active]="propertyForm.get('acceptAnimals')?.value === true"
                  type="button">
            Sim
          </button>
          <button (click)="propertyForm.get('acceptAnimals')?.setValue(false)"
                  [class.active]="propertyForm.get('acceptAnimals')?.value === false"
                  type="button">
            N√£o
          </button>
        </div>
      </div>

      <div class="toggle-item">
        <span class="toggle-label">Tem garagem?</span>
        <div class="toggle-buttons">
          <button (click)="propertyForm.get('hasGarage')?.setValue(true)"
                  [class.active]="propertyForm.get('hasGarage')?.value === true"
                  type="button">
            Sim
          </button>
          <button (click)="propertyForm.get('hasGarage')?.setValue(false)"
                  [class.active]="propertyForm.get('hasGarage')?.value === false"
                  type="button">
            N√£o
          </button>
        </div>
      </div>

    </div>

    <hr>
    <h3>Fotos do Im√≥vel</h3>

    <div class="image-upload-section">
      <p class="upload-hint">
        Adicione fotos para destacar seu an√∫ncio.
      </p>

      <!-- Fotos existentes (modo edi√ß√£o) -->
      <div *ngIf="existingPhotos.length > 0" class="existing-photos">
        <p class="existing-photos-label">Fotos atuais:</p>
        <div class="image-previews">
          <div *ngFor="let photo of existingPhotos; let i = index" class="preview-item">
            <img [src]="photo.url" alt="Foto atual {{ i + 1 }}" class="preview-img">
            <button (click)="removeExistingPhoto(i)" class="remove-btn" title="Remover" type="button">‚úï</button>
          </div>
        </div>
      </div>

      <button (click)="toggleImageUpload()" class="btn-image" type="button">
        üì∏ {{ editMode ? 'Adicionar / Substituir Imagens' : 'Inserir Imagens' }}
      </button>

      <div *ngIf="showImageUpload" class="image-upload-panel">

        <label class="file-input-label" for="fileInput">
          üìÇ Escolher Arquivos
        </label>
        <input (change)="onFileSelected($event)" accept="image/*" class="file-input-hidden" id="fileInput" multiple
               type="file">

        <p class="image-upload-hint">Pode selecionar m√∫ltiplas imagens.</p>

        <div *ngIf="imagePreviews.length > 0" class="image-previews">
          <div *ngFor="let preview of imagePreviews; let i = index" class="preview-item">

            <img [src]="preview" alt="Preview" class="preview-img">

            <button (click)="removeImage(i)" class="remove-btn" title="Remover" type="button">
              ‚úï
            </button>

          </div>
        </div>
      </div>
    </div>

    <div *ngIf="submitSuccess" class="alert-success">‚úÖ {{ editMode ? 'Im√≥vel atualizado com sucesso!' : 'Im√≥vel cadastrado com sucesso!' }} Redirecionando...</div>
    <div *ngIf="submitError" class="alert-error">‚ùå {{ submitError }}</div>

    <button [disabled]="propertyForm.invalid || isSubmitting" type="submit">
      {{ isSubmitting ? 'Salvando...' : 'Salvar Im√≥vel' }}
    </button>
  </form>
</div>
